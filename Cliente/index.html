<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Proyecto De Ingenier√≠a del software</title>
    <link rel="icon" type="image/png" href="/img/android_dark_rd_ctn@2x.png" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" />
    <link rel="stylesheet" href="./styles.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>

    <script>
        (function(){
            if (typeof $ !== 'undefined' && typeof $.cookie !== 'function' && typeof Cookies !== 'undefined'){
                $.cookie = function(name, value, options){
                    if (typeof value === 'undefined'){
                        return Cookies.get(name);
                    }
                    Cookies.set(name, value, options);
                    return Cookies.get(name);
                };
                $.removeCookie = function(name, options){
                    Cookies.remove(name, options);
                    return !Cookies.get(name);
                };
            }
        })();
    </script>

    <script src="./clienteRest.js"></script>
    <script src="./controlWeb.js"></script>
    <script src="./clienteWS.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>
    <!-- The Modal -->
    <div class="modal" id="miModal">
     <div class="modal-dialog">
     <div class="modal-content">
     <!-- Modal Header -->
     <div class="modal-header">
     <h4 class="modal-title">Atenci√≥n</h4>
     <button type="button" class="close" data-dismiss="modal">&times;</button>
     </div>
     <!-- Modal body -->
     <div class="modal-body" id="mBody">
     </div>
     <!-- Modal footer -->
     <div class="modal-footer">
     <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
     </div>
     </div>
     </div>
    </div>
    <nav class="modern-navbar">
        <div class="navbar-container">
            <a id="brandSistema" class="navbar-brand-modern" href="#">
                <span class="brand-text">Registro </span>
            </a>
            
            <ul class="navbar-menu">
                <li class="nav-item-modern">
                    <a id="linkPartidas" class="nav-link-modern" href="#">
                        <i class="fa fa-gamepad"></i>
                        <span>Partidas</span>
                    </a>
                </li>
                <li class="nav-item-modern">
                    <a id="linkEstadisticas" class="nav-link-modern" href="#">
                        <i class="fa fa-chart-line"></i>
                        <span>Estad√≠sticas</span>
                    </a>
                </li>
                <li class="nav-item-modern">
                    <a id="linkPerfil" class="nav-link-modern" href="#">
                        <i class="fa fa-user-circle"></i>
                        <span>Perfil</span>
                    </a>
                </li>
                <li class="nav-item-modern">
                    <a id="linkLogin" class="nav-link-modern" href="#">
                        <i class="fa fa-sign-in-alt"></i>
                        <span>Login</span>
                    </a>
                </li>
                <li class="nav-item-modern">
                    <a id="salir" class="nav-link-modern nav-link-danger" href="#">
                        <i class="fa fa-sign-out-alt"></i>
                        <span>Salir</span>
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <h3>Proyecto de Procesos de Ingenier√≠a del Software</h3>
        <div id="au"></div>
        <div id="registro"></div>
        <div id="msg"></div>
    </div>

    <script>
        rest = new ClienteRest();
        cw = new ControlWeb();
        ws=new ClienteWS();

        // Copiar cookie 'nick' a WS cuanto antes (para restaurar estado tras refresh)
        try {
            if (typeof $ !== 'undefined' && typeof $.cookie === 'function'){
                const nick = $.cookie('nick');
                if (nick){
                    if (typeof ws.setEmail === 'function'){
                        ws.setEmail(nick);
                    } else {
                        ws.email = nick;
                    }
                }
            }
        } catch(e) {}

        cw.comprobarSesion();

        // Al pulsar sobre 'Sistema' mostrar directamente el formulario de registro
        $("#brandSistema").on("click", function(e){
            e.preventDefault();
            if (cw && typeof cw.mostrarRegistro === 'function'){
                cw.mostrarRegistro();
            }
        });

                $("#linkLogin").on("click", function(e){
                    e.preventDefault();
                    if (cw && typeof cw.mostrarLogin === 'function') {
                        cw.mostrarLogin();
                    }
                });

                $("#linkEstadisticas").on("click", function(e){
                    e.preventDefault();
                    const nick = $.cookie("nick");
                    if (!nick){
                        alert('Debes iniciar sesi√≥n para ver tus estad√≠sticas');
                        return;
                    }
                    if (cw && typeof cw.mostrarPaginaEstadisticas === 'function'){
                        cw.mostrarPaginaEstadisticas(nick);
                    }
                });

                $("#linkPerfil").on("click", function(e){
                    e.preventDefault();
                    const nick = $.cookie("nick");
                    if (!nick){
                        alert('Debes iniciar sesi√≥n para ver tu perfil');
                        return;
                    }
                    if (cw && typeof cw.mostrarPaginaPerfil === 'function'){
                        cw.mostrarPaginaPerfil(nick);
                    }
                });

                $("#linkPartidas").on("click", function(e){
                    e.preventDefault();
                    if (cw && typeof cw.mostrarPartidas === 'function'){
                        cw.mostrarPartidas();
                    }
                });


        $("#salir").on("click", function(e){
            e.preventDefault();
            if (cw && typeof cw.salir === 'function') cw.salir();
        });

        // ‚úÖ --- GOOGLE ONE TAP INITIALIZATION (FedCM Compatible) ---
        window.onload = function() {
            function handleCredentialResponse(response){
                try {
                    const cred = response && response.credential;
                    if (!cred){
                        console.log('[oneTap] Sin credential en callback');
                        return;
                    }
                    // Enviar credential a nuestro backend desde el mismo origen (evita restricciones de cookies en local)
                    fetch('/oneTap/callback', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ credential: cred })
                    }).then(async (res) => {
                        if (res.ok){
                            const data = await res.json().catch(()=>({}));
                            console.log('[oneTap] Respuesta backend:', data);
                            // Recargar para que el front lea la cookie y actualice la UI
                            window.location.reload();
                        } else {
                            const txt = await res.text();
                            console.warn('[oneTap] Backend error:', res.status, txt);
                            document.getElementById('msg')?.insertAdjacentHTML('afterbegin', `<div class="alert alert-danger">Error One Tap (${res.status}).</div>`);
                        }
                    }).catch((e)=>{
                        console.error('[oneTap] Fetch error:', e);
                        document.getElementById('msg')?.insertAdjacentHTML('afterbegin', `<div class="alert alert-danger">Error de red One Tap.</div>`);
                    });
                } catch(e){ console.error(e); }
            }

            google.accounts.id.initialize({
                client_id: "747124604783-2dbkftslri635jj8abl4jfvq05fcu59d.apps.googleusercontent.com",
                callback: handleCredentialResponse,
                use_fedcm_for_prompt: true // üëà Activa FedCM (obligatorio desde 2025)
            });

            // Solo mostrar One Tap si no hay sesi√≥n iniciada (cookie 'nick')
            try {
                var hasNick = (typeof $ !== 'undefined' && typeof $.cookie === 'function') ? $.cookie('nick') : null;
                if (!hasNick) {
                    google.accounts.id.prompt((notification) => {
                        console.log("Google One Tap status:", notification);
                        if (notification.isNotDisplayed()) {
                            console.log("No se muestra One Tap:", notification.getNotDisplayedReason());
                        }
                        if (notification.isSkippedMoment()) {
                            console.log("One Tap saltado:", notification.getSkippedReason());
                        }
                        if (notification.isDismissedMoment()) {
                            console.log("One Tap cerrado por el usuario");
                        }
                    });
                } else {
                    console.log('One Tap desactivado: sesi√≥n ya iniciada');
                }
            } catch(e){ console.warn('No se pudo comprobar cookie nick:', e); }
        };
    </script>
</body>
</html>
