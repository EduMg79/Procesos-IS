<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Proyecto De Ingenier√≠a del software</title>
    <link rel="icon" type="image/png" href="/img/android_dark_rd_ctn@2x.png" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" />
    <link rel="stylesheet" href="./styles.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>

    <script>
        (function(){
            if (typeof $ !== 'undefined' && typeof $.cookie !== 'function' && typeof Cookies !== 'undefined'){
                $.cookie = function(name, value, options){
                    if (typeof value === 'undefined'){
                        return Cookies.get(name);
                    }
                    Cookies.set(name, value, options);
                    return Cookies.get(name);
                };
                $.removeCookie = function(name, options){
                    Cookies.remove(name, options);
                    return !Cookies.get(name);
                };
            }
        })();
    </script>

    <script src="./clienteRest.js"></script>
    <script src="./controlWeb.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>
    <nav class="navbar navbar-expand-sm bg-dark navbar-dark">
    <a id="brandSistema" class="navbar-brand" href="#">Sistema</a>
        <ul class="navbar-nav">
            <li class="nav-item">
                <a id="salir" class="nav-link" href="#">Salir</a>
            </li>
            <li class="nav-item">
                    <li class="nav-item">
                        <a id="linkLogin" class="nav-link" href="#">Login</a>
                    </li>
                <a class="nav-link" href="#">Link 3</a>
            </li>
        </ul>
    </nav>

    <div class="container">
        <h3>Proyecto de Procesos de Ingenier√≠a del Software</h3>
        <div id="au"></div>
        <div id="registro"></div>
        <div id="msg"></div>
    </div>

    <script>
        rest = new ClienteRest();
        cw = new ControlWeb();
        cw.comprobarSesion();

        // Al pulsar sobre 'Sistema' mostrar directamente el formulario de registro
        $("#brandSistema").on("click", function(e){
            e.preventDefault();
            if (cw && typeof cw.mostrarRegistro === 'function'){
                cw.mostrarRegistro();
            }
        });

                $("#linkLogin").on("click", function(e){
                    e.preventDefault();
                    if (cw && typeof cw.mostrarLogin === 'function') {
                        cw.mostrarLogin();
                    }
                });


        $("#salir").on("click", function(e){
            e.preventDefault();
            if (cw && typeof cw.salir === 'function') cw.salir();
        });

        // ‚úÖ --- GOOGLE ONE TAP INITIALIZATION (FedCM Compatible) ---
        window.onload = function() {
            function handleCredentialResponse(response){
                try {
                    const cred = response && response.credential;
                    if (!cred){
                        console.log('[oneTap] Sin credential en callback');
                        return;
                    }
                    // Enviar credential a nuestro backend desde el mismo origen (evita restricciones de cookies en local)
                    fetch('/oneTap/callback', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ credential: cred })
                    }).then(async (res) => {
                        if (res.ok){
                            const data = await res.json().catch(()=>({}));
                            console.log('[oneTap] Respuesta backend:', data);
                            // Recargar para que el front lea la cookie y actualice la UI
                            window.location.reload();
                        } else {
                            const txt = await res.text();
                            console.warn('[oneTap] Backend error:', res.status, txt);
                            document.getElementById('msg')?.insertAdjacentHTML('afterbegin', `<div class="alert alert-danger">Error One Tap (${res.status}).</div>`);
                        }
                    }).catch((e)=>{
                        console.error('[oneTap] Fetch error:', e);
                        document.getElementById('msg')?.insertAdjacentHTML('afterbegin', `<div class="alert alert-danger">Error de red One Tap.</div>`);
                    });
                } catch(e){ console.error(e); }
            }

            google.accounts.id.initialize({
                client_id: "747124604783-2dbkftslri635jj8abl4jfvq05fcu59d.apps.googleusercontent.com",
                callback: handleCredentialResponse,
                use_fedcm_for_prompt: true // üëà Activa FedCM (obligatorio desde 2025)
            });

            google.accounts.id.prompt((notification) => {
                console.log("Google One Tap status:", notification);
                if (notification.isNotDisplayed()) {
                    console.log("No se muestra One Tap:", notification.getNotDisplayedReason());
                }
                if (notification.isSkippedMoment()) {
                    console.log("One Tap saltado:", notification.getSkippedReason());
                }
                if (notification.isDismissedMoment()) {
                    console.log("One Tap cerrado por el usuario");
                }
            });
        };
    </script>
</body>
</html>
